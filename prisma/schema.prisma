generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  ANALYST
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BLOCKED
}

enum KycStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

enum TransactionType {
  PAY_FOR_ME
  GROUP_SPLIT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  SUCCESSFUL
  FAILED
  CANCELLED
  PARTIAL
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum SettlementStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  SETTLED
}

enum DocumentType {
  CAC_CERTIFICATE
  PROOF_OF_ADDRESS
  IDENTITY_DOCUMENT
  DIRECTOR_ID
}

enum OnboardingStatus {
  DRAFT
  SUBMITTED
  APPROVED
  ACTIVE
}

enum SettlementType {
  T_0
  T_1
  MANUAL
}

// Admin Users (from AdminBackendInstruction.md)
model AdminUser {
  id          String   @id @default(uuid())
  email       String   @unique
  name        String
  passwordHash String
  role        UserRole
  permissions String[]
  department  String?
  status      UserStatus @default(ACTIVE)
  lastLogin   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("admin_users")
}

// Regular Users (from MerchantBackendInstruction.md)
model User {
  id            String     @id @default(uuid())
  email         String     @unique
  passwordHash  String
  phone         String?
  firstName     String?
  lastName      String?
  status        UserStatus @default(PENDING)
  emailVerified Boolean    @default(false)
  phoneVerified Boolean    @default(false)
  walletBalance Decimal    @default(0)
  currency      String     @default("NGN")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  lastLogin     DateTime?

  // Relations
  merchants Merchant[]

  @@map("users")
}

// Merchants (from both instruction documents)
model Merchant {
  id                    String            @id @default(uuid())
  userId                String
  businessName          String
  businessEmail         String?
  businessPhone         String?
  businessAddress       String?
  businessType          String?
  websiteUrl            String?
  cacNumber             String?
  taxId                 String?
  kycStatus             KycStatus         @default(PENDING)
  onboardingStatus      OnboardingStatus  @default(DRAFT)
  kycSubmittedAt        DateTime?
  kycApprovedAt         DateTime?
  apiKey                String?           @unique
  webhookUrl            String?
  settlementAccountNumber String?
  settlementBankCode    String?
  settlementAccountName String?
  settlementSchedule    String            @default("daily")
  fees                  Json?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  kycDocuments      KycDocument[]
  directors         Director[]
  transactions      Transaction[]
  settlements       Settlement[]
  qrCodes           QrCode[]

  @@map("merchants")
}

// KYC Documents
model KycDocument {
  id          String       @id @default(uuid())
  merchantId  String
  documentType DocumentType
  fileName    String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  status      KycStatus    @default(PENDING)
  uploadedAt  DateTime     @default(now())

  // Relations
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

// Directors
model Director {
  id                  String  @id @default(uuid())
  merchantId          String
  fullName            String
  bvn                 String
  phone               String?
  email               String?
  ownershipPercentage Decimal?
  createdAt           DateTime @default(now())

  // Relations
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@map("directors")
}

// Transactions (from both instruction documents)
model Transaction {
  id                String            @id @default(uuid())
  merchantId        String?
  reference         String            @unique
  type              TransactionType
  amount            Decimal
  currency          String            @default("NGN")
  status            TransactionStatus @default(PENDING)
  description       String?
  customerName      String?
  customerEmail     String?
  customerPhone     String?
  paymentMethod     String?
  paymentGateway    String?
  gatewayReference  String?
  merchantFee       Decimal           @default(0)
  gatewayFee        Decimal           @default(0)
  netAmount         Decimal?
  settlementStatus  SettlementStatus  @default(PENDING)
  settledAt         DateTime?
  expiresAt         DateTime?
  metadata          Json?
  fraudScore        Decimal?
  fraudFlags        String[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  completedAt       DateTime?

  // Relations
  merchant                Merchant?                @relation(fields: [merchantId], references: [id], onDelete: SetNull)
  groupSplitContributors  GroupSplitContributor[]
  settlementItems         SettlementItem[]
  refunds                 Refund[]
  fraudFlagsRelation      FraudFlag[]

  @@map("transactions")
}

// Group Split Contributors
model GroupSplitContributor {
  id              String        @id @default(uuid())
  transactionId   String
  name            String
  email           String
  phone           String?
  amount          Decimal
  status          PaymentStatus @default(PENDING)
  paymentReference String?
  paidAt          DateTime?
  paymentMethod   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("group_split_contributors")
}

// Settlements
model Settlement {
  id                String          @id @default(uuid())
  merchantId        String
  periodStart       DateTime
  periodEnd         DateTime
  totalAmount       Decimal
  feeAmount         Decimal
  netAmount         Decimal
  transactionCount  Int             @default(0)
  status            SettlementStatus @default(PENDING)
  bankAccount       Json?
  reference         String?
  settlementType    SettlementType  @default(T_1)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  processedAt       DateTime?

  // Relations
  merchant        Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  settlementItems SettlementItem[]

  @@map("settlements")
}

// Settlement Items
model SettlementItem {
  id            String     @id @default(uuid())
  settlementId  String
  transactionId String
  amount        Decimal
  fee           Decimal    @default(0)
  netAmount     Decimal

  // Relations
  settlement  Settlement  @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("settlement_items")
}

// Refunds
model Refund {
  id           String          @id @default(uuid())
  paymentId    String
  amount       Decimal
  reason       String
  status       SettlementStatus @default(PENDING)
  requestedBy  String
  processedBy  String?
  createdAt    DateTime        @default(now())
  processedAt  DateTime?

  // Relations
  transaction Transaction @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("refunds")
}

// QR Codes
model QrCode {
  id          String   @id @default(uuid())
  merchantId  String
  name        String
  type        TransactionType
  amount      Decimal?
  description String?
  isActive    Boolean  @default(true)
  usageLimit  Int?
  usageCount  Int      @default(0)
  expiresAt   DateTime?
  qrData      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  merchant Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@map("qr_codes")
}

// Admin Audit Logs
model AdminLog {
  id           String   @id @default(uuid())
  adminUserId  String
  action       String
  resourceType String
  resourceId   String?
  changes      Json?
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  @@map("admin_logs")
}

// Fraud Flags
model FraudFlag {
  id            String   @id @default(uuid())
  transactionId String
  reason        String
  score         Decimal?
  createdAt     DateTime @default(now())

  // Relations
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("fraud_flags")
}